<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Axiom</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: monospace;
    height: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #loader {
    text-align: center;
  }

  #screen {
    display: none;
    box-sizing: border-box;
    padding: 12px;
    height: 100%;
    width: 100%;
    overflow-y: auto;
    white-space: pre-wrap;
    background: #000;
    color: #fff;
  }

  #input-line {
    display: flex;
    width: 100%;
  }

  #input {
    flex: 1;
    background: transparent;
    border: none;
    color: inherit;
    font-family: inherit;
    outline: none;
  }

  #file-input {
    display: none;
  }
</style>
</head>
<body>

<div id="loader">
  <div style="font-size: 32px; margin-bottom: 20px;">A X I O M</div>
  <div style="margin-bottom: 10px;">Load a .ax world file</div>
  <button id="load-btn">Choose File</button>
</div>

<div id="screen"></div>
<input id="file-input" type="file" accept=".ax" />

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script type="module">

/* ============================================================
   AXIOM RUNTIME
============================================================ */

const loader = document.getElementById("loader");
const screen = document.getElementById("screen");
const fileInput = document.getElementById("file-input");
const loadBtn = document.getElementById("load-btn");

let inputCallback = null;

/* Basic DOM helpers */
function print(text = "", opts = {}) {
  const div = document.createElement("div");
  const span = document.createElement("span");
  span.textContent = text;
  if (opts.color) span.style.color = opts.color;
  if (opts.bgColor) span.style.backgroundColor = opts.bgColor;
  div.appendChild(span);
  screen.appendChild(div);
  screen.scrollTop = screen.scrollHeight;
}

function clearScreen() {
  screen.innerHTML = "";
}

function setTheme({ fg, bg }) {
  if (fg) screen.style.color = fg;
  if (bg) screen.style.backgroundColor = bg;
}

function setTitle(text) {
  document.title = text;
}

/* Input handling */
function enableInput() {
  const inputLine = document.createElement("div");
  inputLine.id = "input-line";

  const input = document.createElement("input");
  input.id = "input";
  input.autocomplete = "off";

  inputLine.appendChild(input);
  screen.appendChild(inputLine);
  input.focus();

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const value = input.value;
      input.value = "";
      if (inputCallback) inputCallback(value);
    }
  });
}

/* Axiom API exposed to .ax worlds */
const axiom = {
  print,
  clear: clearScreen,
  onInput(fn) { inputCallback = fn; },
  setTitle,
  setTheme
};

/* ============================================================
   LOAD .AX FILE
============================================================ */

loadBtn.onclick = () => fileInput.click();

fileInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  const buf = await file.arrayBuffer();
  const zip = await JSZip.loadAsync(buf);

  const mainJs = zip.file("main.js");
  if (!mainJs) {
    alert("Invalid .ax file: missing main.js");
    return;
  }

  const code = await mainJs.async("string");

  // Turn main.js into a module
  const blob = new Blob([code], { type: "text/javascript" });
  const url = URL.createObjectURL(blob);
  const mod = await import(url);
  URL.revokeObjectURL(url);

  if (typeof mod.start !== "function") {
    alert("main.js must export function start(axiom)");
    return;
  }

  // Hide loader, show screen
  loader.style.display = "none";
  screen.style.display = "block";

  // Enable input
  enableInput();

  // Run the world
  mod.start(axiom);
};

</script>
</body>
</html>
