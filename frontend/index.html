<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Axiom</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: monospace;
    height: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #loader {
    text-align: center;
  }

  #screen {
    display: none;
    box-sizing: border-box;
    padding: 12px;
    height: 100%;
    width: 100%;
    overflow-y: auto;
    white-space: pre-wrap;
    background: #000;
    color: #fff;
  }

  #file-input {
    display: none;
  }
</style>
</head>
<body>

<div id="loader">
  <div style="font-size: 32px; margin-bottom: 20px;">A X I O M</div>
  <div style="margin-bottom: 10px;">Load a .ax world file</div>
  <button id="load-btn">Choose File</button>
</div>

<div id="screen"></div>
<input id="file-input" type="file" accept=".ax" />

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script type="module">
/* ============================================================
   AXIOM RUNTIME
============================================================ */

const loader = document.getElementById("loader");
const screen = document.getElementById("screen");
const fileInput = document.getElementById("file-input");
const loadBtn = document.getElementById("load-btn");

let inputCallback = null;
let inputLine = null;
let inputBox = null;
let inputStyle = { fg: null, bg: null };

/* ---------- Printing ---------- */

function print(text = "", opts = {}) {
  const div = document.createElement("div");
  const span = document.createElement("span");
  span.textContent = text;
  if (opts.color) span.style.color = opts.color;
  if (opts.bgColor) span.style.backgroundColor = opts.bgColor;
  div.appendChild(span);

  if (inputLine && inputLine.parentNode === screen) {
    screen.insertBefore(div, inputLine);
  } else {
    screen.appendChild(div);
  }

  screen.scrollTop = screen.scrollHeight;
  attachInputLineIfNeeded();
}

function printError(label, err) {
  const msg = (err && err.stack) ? err.stack : String(err);
  print(`âœ– ${label}:`, { color: "#f55" });
  print(msg, { color: "#f88" });
  print("");
}

/* ---------- Screen / theme ---------- */

function clearScreen() {
  screen.innerHTML = "";
  inputLine = null;
  inputBox = null;
}

function setTheme({ fg, bg }) {
  if (fg) screen.style.color = fg;
  if (bg) screen.style.backgroundColor = bg;
}

function setTitle(text) {
  document.title = text;
}

/* ---------- Input handling ---------- */

function applyInputStyle() {
  if (!inputBox) return;
  if (inputStyle.fg) inputBox.style.color = inputStyle.fg;
  if (inputStyle.bg) inputBox.style.backgroundColor = inputStyle.bg;
}

function attachInputLineIfNeeded() {
  if (!inputLine || !inputBox) return;
  if (inputLine.parentNode !== screen) {
    screen.appendChild(inputLine);
  } else {
    screen.appendChild(inputLine);
  }
  applyInputStyle();
  inputBox.focus();
}

function createInputLine() {
  if (inputLine) return;

  inputLine = document.createElement("div");
  inputBox = document.createElement("input");

  inputBox.autocomplete = "off";
  inputBox.style.border = "none";
  inputBox.style.outline = "none";
  inputBox.style.background = "transparent";
  inputBox.style.color = "inherit";
  inputBox.style.fontFamily = "inherit";
  inputBox.style.width = "100%";

  inputLine.appendChild(inputBox);

  inputBox.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const value = inputBox.value;
      inputBox.value = "";
      if (inputCallback) {
        try {
          inputCallback(value);
        } catch (err) {
          printError("Error in onInput handler", err);
        }
      }
    }
  });

  attachInputLineIfNeeded();
}

/* ---------- Axiom API ---------- */

const axiom = {
  print,
  clear: clearScreen,
  onInput(fn) {
    inputCallback = fn;
    if (!inputLine) createInputLine();
  },
  setTitle,
  setTheme,
  setInputStyle({ fg, bg }) {
    inputStyle = { fg: fg || null, bg: bg || null };
    applyInputStyle();
  }
};

/* ---------- Global error hooks ---------- */

window.onerror = (msg, src, line, col, err) => {
  screen.style.display = "block";
  loader.style.display = "none";
  printError("Global error", err || msg);
};

window.onunhandledrejection = event => {
  screen.style.display = "block";
  loader.style.display = "none";
  printError("Unhandled promise rejection", event.reason);
};

/* ============================================================
   LOAD .AX FILE
============================================================ */

loadBtn.onclick = () => fileInput.click();

fileInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const buf = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(buf);

    const mainJs = zip.file("main.js");
    if (!mainJs) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("main.js error", "Invalid .ax file: missing main.js");
      return;
    }

    const code = await mainJs.async("string");

    const blob = new Blob([code], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);

    let mod;
    try {
      mod = await import(url);
    } catch (err) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Error importing main.js", err);
      URL.revokeObjectURL(url);
      return;
    }

    URL.revokeObjectURL(url);

    if (typeof mod.start !== "function") {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("main.js error", "main.js must export function start(axiom)");
      return;
    }

    loader.style.display = "none";
    screen.style.display = "block";

    try {
      mod.start(axiom);
    } catch (err) {
      printError("Error in start(axiom)", err);
    }
  } catch (err) {
    screen.style.display = "block";
    loader.style.display = "none";
    printError("Error loading .ax file", err);
  }
};
</script>
</body>
</html>

