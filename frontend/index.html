<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Axiom</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: monospace;
    height: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: none; /* hidden by default */
  }

  #loader {
    text-align: center;
  }

  #screen {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    box-sizing: border-box;
    padding: 12px;
    height: 100%;
    width: 100%;
    overflow-y: auto;
    white-space: pre-wrap;
    background: #000;
    color: #fff;
  }

  #file-input {
    display: none;
  }

  canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
  }
</style>
</head>
<body>

<div id="loader">
  <div style="font-size: 32px; margin-bottom: 20px;">A X I O M</div>
  <div style="margin-bottom: 10px;">Load a .ax world file</div>
  <button id="load-btn">Choose File</button>
</div>

<div id="screen"></div>
<input id="file-input" type="file" accept=".ax" />

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script type="module">
/* ============================================================
   AXIOM RUNTIME — SINGLE MODE
============================================================ */

const loader = document.getElementById("loader");
const screen = document.getElementById("screen");
const fileInput = document.getElementById("file-input");
const loadBtn = document.getElementById("load-btn");

let inputCallback = null;
let inputLine = null;
let inputBox = null;
let inputStyle = { fg: null, bg: null };
let canvas = null;
let ctx = null;
let mouseEnabled = false;
let mode = "text"; // "text" or "graphics"

/* ---------- Printing (text mode only) ---------- */

function print(text = "", opts = {}) {
  if (mode !== "text") return;

  const div = document.createElement("div");
  const span = document.createElement("span");
  span.textContent = text;
  if (opts.color) span.style.color = opts.color;
  if (opts.bgColor) span.style.backgroundColor = opts.bgColor;
  div.appendChild(span);

  if (inputLine && inputLine.parentNode === screen) {
    screen.insertBefore(div, inputLine);
  } else {
    screen.appendChild(div);
  }

  screen.scrollTop = screen.scrollHeight;
  attachInputLineIfNeeded();
}

function printError(label, err) {
  const msg = (err && err.stack) ? err.stack : String(err);
  print(`✖ ${label}:`, { color: "#f55" });
  print(msg, { color: "#f88" });
  print("");
}

/* ---------- Screen / theme ---------- */

function clearScreen() {
  if (mode === "text") {
    screen.innerHTML = "";
    inputLine = null;
    inputBox = null;
  }
}

function setTheme({ fg, bg }) {
  if (mode === "text") {
    if (fg) screen.style.color = fg;
    if (bg) screen.style.backgroundColor = bg;
  }
}

function setTitle(text) {
  document.title = text;
}

/* ---------- Input handling (text mode only) ---------- */

function applyInputStyle() {
  if (!inputBox) return;
  if (inputStyle.fg) inputBox.style.color = inputStyle.fg;
  if (inputStyle.bg) inputBox.style.backgroundColor = inputStyle.bg;
}

function attachInputLineIfNeeded() {
  if (mode !== "text") return;
  if (!inputLine || !inputBox) return;

  if (inputLine.parentNode !== screen) {
    screen.appendChild(inputLine);
  } else {
    screen.appendChild(inputLine);
  }

  applyInputStyle();
  inputBox.focus();
}

function createInputLine() {
  if (mode !== "text") return;
  if (inputLine) return;

  inputLine = document.createElement("div");
  inputBox = document.createElement("input");

  inputBox.autocomplete = "off";
  inputBox.style.border = "none";
  inputBox.style.outline = "none";
  inputBox.style.background = "transparent";
  inputBox.style.color = "inherit";
  inputBox.style.fontFamily = "inherit";
  inputBox.style.width = "100%";

  inputLine.appendChild(inputBox);

  inputBox.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const value = inputBox.value;
      inputBox.value = "";
      if (inputCallback) {
        try {
          inputCallback(value);
        } catch (err) {
          printError("Error in onInput handler", err);
        }
      }
    }
  });

  attachInputLineIfNeeded();
}

/* ---------- Graphics mode ---------- */

function enableGraphics() {
  mode = "graphics";
  screen.style.display = "none";

  if (!canvas) {
    canvas = document.createElement("canvas");
    canvas.style.pointerEvents = "none";
    document.body.appendChild(canvas);
    ctx = canvas.getContext("2d");

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    resize();
    window.addEventListener("resize", resize);
  }

  return ctx;
}

/* ---------- Mouse ---------- */

function enableMouse(options = {}) {
  mouseEnabled = true;
  document.body.style.cursor = options.cursor || "default";

  const onMove = options.onMove || (() => {});
  const onDown = options.onDown || (() => {});
  const onUp = options.onUp || (() => {});

  window.addEventListener("mousemove", e => {
    if (!mouseEnabled) return;
    onMove(e.clientX, e.clientY);
  });

  window.addEventListener("mousedown", e => {
    if (!mouseEnabled) return;
    onDown(e.clientX, e.clientY);
  });

  window.addEventListener("mouseup", e => {
    if (!mouseEnabled) return;
    onUp(e.clientX, e.clientY);
  });
}

/* ---------- Axiom API ---------- */

const axiom = {
  print,
  clear: clearScreen,
  onInput(fn) {
    if (mode !== "text") throw new Error("Input not allowed in graphics mode");
    inputCallback = fn;
    if (!inputLine) createInputLine();
  },
  setTitle,
  setTheme,
  setInputStyle({ fg, bg }) {
    inputStyle = { fg: fg || null, bg: bg || null };
    applyInputStyle();
  },
  enableGraphics,
  enableMouse
};

/* ---------- Error hooks ---------- */

window.onerror = (msg, src, line, col, err) => {
  screen.style.display = "block";
  loader.style.display = "none";
  printError("Global error", err || msg);
};

window.onunhandledrejection = event => {
  screen.style.display = "block";
  loader.style.display = "none";
  printError("Unhandled promise rejection", event.reason);
};

/* ============================================================
   LOAD .AX FILE + init.axconf
============================================================ */

loadBtn.onclick = () => fileInput.click();

fileInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const buf = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(buf);

    const confFile = zip.file("init.axconf");
    if (!confFile) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Config error", "Missing init.axconf");
      return;
    }

    const confText = await confFile.async("string");
    let config = {};
    try {
      config = JSON.parse(confText);
    } catch (err) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Config parse error", err);
      return;
    }

    const entry = config.entry || "main.js";
    const graphicsMode = config.graphics === true;
    const textMode = config.text !== false; // default true
    const allowMouse = config.mouse === true;

    if (graphicsMode && textMode) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Config error", "Cannot enable both text and graphics mode");
      return;
    }

    mode = graphicsMode ? "graphics" : "text";

    if (!textMode) screen.style.display = "none";
    if (textMode) screen.style.display = "block";

    if (!allowMouse) axiom.enableMouse = () => { throw new Error("Mouse disabled by init.axconf"); };

    const entryFile = zip.file(entry);
    if (!entryFile) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Entry error", `Missing entry script: ${entry}`);
      return;
    }

    const code = await entryFile.async("string");

    const blob = new Blob([code], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);

    let mod;
    try {
      mod = await import(url);
    } catch (err) {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Error importing entry script", err);
      URL.revokeObjectURL(url);
      return;
    }

    URL.revokeObjectURL(url);

    if (typeof mod.start !== "function") {
      screen.style.display = "block";
      loader.style.display = "none";
      printError("Entry error", `${entry} must export function start(axiom)`);
      return;
    }

    loader.style.display = "none";

    try {
      mod.start(axiom);
    } catch (err) {
      printError("Error in start(axiom)", err);
    }

  } catch (err) {
    screen.style.display = "block";
    loader.style.display = "none";
    printError("Error loading .ax file", err);
  }
};
</script>
</body>
</html>
