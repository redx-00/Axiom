<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Axiom</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: monospace;
    height: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: none;
  }
  #loader { text-align: center; }
  #screen {
    display: none;
    position: absolute;
    top: 0; left: 0;
    box-sizing: border-box;
    padding: 12px;
    height: 100%; width: 100%;
    overflow-y: auto;
    white-space: pre-wrap;
    background: #000;
    color: #fff;
  }
  #file-input { display: none; }
</style>
</head>
<body>
<div id="loader">
  <div style="font-size:32px;margin-bottom:20px;">A X I O M</div>
  <div style="margin-bottom:10px;">Load a .ax world file</div>
  <button id="load-btn">Choose File</button>
  <div style="margin-top:10px;font-size:12px;color:#888;">Press F2 for BIOS</div>
</div>
<div id="screen"></div>
<input id="file-input" type="file" accept=".ax" />
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script type="module">
const loader = document.getElementById("loader");
const screen = document.getElementById("screen");
const fileInput = document.getElementById("file-input");
const loadBtn = document.getElementById("load-btn");

let mode = "loader"; // loader | bios | world
let inputCallback = null;
let inputLine = null;
let inputBox = null;
let inputStyle = { fg: null, bg: null };
let currentWorldId = "none";

/* ---------- storage API ---------- */
function makeStorage(prefix) {
  return {
    set(key, value) {
      localStorage.setItem(prefix + key, JSON.stringify(value));
    },
    get(key) {
      const v = localStorage.getItem(prefix + key);
      return v ? JSON.parse(v) : null;
    },
    remove(key) {
      localStorage.removeItem(prefix + key);
    },
    keys() {
      const out = [];
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith(prefix)) out.push(k.slice(prefix.length));
      }
      return out;
    },
    clear() {
      this.keys().forEach(k => localStorage.removeItem(prefix + k));
    }
  };
}

/* ---------- text UI primitives ---------- */
function clearScreen() {
  screen.innerHTML = "";
  inputLine = null;
  inputBox = null;
}
function print(text = "", opts = {}) {
  const div = document.createElement("div");
  const span = document.createElement("span");
  span.textContent = text;
  if (opts.color) span.style.color = opts.color;
  if (opts.bgColor) span.style.backgroundColor = opts.bgColor;
  div.appendChild(span);
  screen.appendChild(div);
  screen.scrollTop = screen.scrollHeight;
  attachInputLineIfNeeded();
}
function printError(label, err) {
  const msg = (err && err.stack) ? err.stack : String(err);
  print(`âœ– ${label}:`, { color: "#f55" });
  print(msg, { color: "#f88" });
  print("");
}
function setTheme({ fg, bg }) {
  if (fg) screen.style.color = fg;
  if (bg) screen.style.backgroundColor = bg;
}
function setTitle(text) {
  document.title = text;
}
function applyInputStyle() {
  if (!inputBox) return;
  if (inputStyle.fg) inputBox.style.color = inputStyle.fg;
  if (inputStyle.bg) inputBox.style.backgroundColor = inputStyle.bg;
}
function attachInputLineIfNeeded() {
  if (!inputLine || !inputBox) return;
  if (inputLine.parentNode !== screen) screen.appendChild(inputLine);
  applyInputStyle();
  inputBox.focus();
}
function createInputLine() {
  if (inputLine) return;
  inputLine = document.createElement("div");
  inputBox = document.createElement("input");
  inputBox.autocomplete = "off";
  inputBox.style.border = "none";
  inputBox.style.outline = "none";
  inputBox.style.background = "transparent";
  inputBox.style.color = "inherit";
  inputBox.style.fontFamily = "inherit";
  inputBox.style.width = "100%";
  inputLine.appendChild(inputBox);
  inputBox.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const value = inputBox.value;
      inputBox.value = "";
      if (inputCallback) {
        try { inputCallback(value); }
        catch (err) { printError("Error in input handler", err); }
      }
    }
  });
  attachInputLineIfNeeded();
}

/* ---------- BIOS ---------- */
function enterBIOS() {
  mode = "bios";
  loader.style.display = "none";
  screen.style.display = "block";
  clearScreen();
  setTitle("Axiom BIOS");
  setTheme({ fg: "#ffcc00", bg: "#000000" });
  print("A X I O M   B I O S", { color: "#ff0" });
  print("--------------------");
  print("1. Storage");
  print("2. Experimental Flags");
  print("3. Danger Zone");
  print("4. Exit BIOS");
  print("");
  print("Type a number and press Enter.");
  inputCallback = biosMainMenu;
  if (!inputLine) createInputLine();
}
function biosPrompt() {
  print("BIOS> ", { color: "#ff0" });
}
function biosMainMenu(line) {
  if (line === undefined) { biosPrompt(); return; }
  const choice = line.trim();
  if (choice === "1") {
    clearScreen();
    print("Storage keys:", { color: "#ff0" });
    const ks = Object.keys(localStorage);
    if (!ks.length) print("(no keys)");
    else ks.forEach(k => print(k));
    print("");
    biosPrompt();
  } else if (choice === "2") {
    clearScreen();
    print("Experimental flags (axiom::exp::*):", { color: "#ff0" });
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k.startsWith("axiom::exp::")) {
        print(k + " = " + localStorage.getItem(k));
      }
    }
    print("");
    biosPrompt();
  } else if (choice === "3") {
    clearScreen();
    print("DANGER ZONE", { color: "#f55" });
    print("Type 'WIPE' to clear ALL localStorage.");
    print("Type 'BACK' to return.");
    print("");
    inputCallback = biosDanger;
    biosPrompt();
  } else if (choice === "4") {
    // exit BIOS back to loader
    mode = "loader";
    screen.style.display = "none";
    loader.style.display = "block";
    setTitle("Axiom");
    inputCallback = null;
    inputLine = null;
    inputBox = null;
  } else {
    biosPrompt();
  }
}
function biosDanger(line) {
  const cmd = (line || "").trim().toUpperCase();
  if (cmd === "WIPE") {
    print("Wiping ALL localStorage...", { color: "#f55" });
    localStorage.clear();
    print("Done.");
  } else if (cmd === "BACK") {
    clearScreen();
    print("A X I O M   B I O S", { color: "#ff0" });
    print("--------------------");
    print("1. Storage");
    print("2. Experimental Flags");
    print("3. Danger Zone");
    print("4. Exit BIOS");
    print("");
    inputCallback = biosMainMenu;
  }
  biosPrompt();
}

/* ---------- world API wrapper ---------- */
function makeAxiomAPI(worldId) {
  const storage = makeStorage("axiom::" + worldId + "::");
  return {
    print,
    clear: clearScreen,
    onInput(fn) {
      inputCallback = fn;
      if (!inputLine) createInputLine();
    },
    setTitle,
    setTheme,
    setInputStyle({ fg, bg }) {
      inputStyle = { fg: fg || null, bg: bg || null };
      applyInputStyle();
    },
    storage
  };
}

/* ---------- .ax loader (new format) ---------- */
async function loadAxWorld(file) {
  const buf = await file.arrayBuffer();
  const view = new DataView(buf);
  // header: "AXIOM\0\0" + version=1
  const magic = [0x41,0x58,0x49,0x4F,0x4D,0x00,0x00,0x01];
  for (let i = 0; i < magic.length; i++) {
    if (view.getUint8(i) !== magic[i]) throw new Error("Invalid AX header");
  }
  const manifestLen = view.getUint32(8, false); // big-endian
  const manifestStart = 12;
  const manifestEnd = manifestStart + manifestLen;
  const manifestBytes = new Uint8Array(buf, manifestStart, manifestLen);
  const manifestText = new TextDecoder("utf-8").decode(manifestBytes);
  const manifest = JSON.parse(manifestText);
  currentWorldId = manifest.id || "world";
  const zipBuf = buf.slice(manifestEnd);
  const zip = await JSZip.loadAsync(zipBuf);
  const entryPath = manifest.entry || "main.js";
  const configPath = manifest.config || "init.axconf";
  const entryFile = zip.file(entryPath);
  if (!entryFile) throw new Error("Missing entry script: " + entryPath);
  // config is optional for now
  const code = await entryFile.async("string");
  const blob = new Blob([code], { type: "text/javascript" });
  const url = URL.createObjectURL(blob);
  let mod;
  try {
    mod = await import(url);
  } finally {
    URL.revokeObjectURL(url);
  }
  if (typeof mod.start !== "function") {
    throw new Error("Entry must export function start(axiom)");
  }
  // switch to world mode
  mode = "world";
  loader.style.display = "none";
  screen.style.display = "block";
  clearScreen();
  const axiom = makeAxiomAPI(currentWorldId);
  try {
    mod.start(axiom);
  } catch (err) {
    printError("Error in start(axiom)", err);
  }
}

/* ---------- global error hooks ---------- */
window.onerror = (msg, src, line, col, err) => {
  screen.style.display = "block";
  loader.style.display = "none";
  printError("Global error", err || msg);
};
window.onunhandledrejection = event => {
  screen.style.display = "block";
  loader.style.display = "none";
  printError("Unhandled promise rejection", event.reason);
};

/* ---------- boot controls ---------- */
loadBtn.onclick = () => fileInput.click();
fileInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    await loadAxWorld(file);
  } catch (err) {
    screen.style.display = "block";
    loader.style.display = "none";
    printError("Error loading .ax world", err);
  }
};
window.addEventListener("keydown", e => {
  if (e.key === "F2" && mode !== "bios") {
    enterBIOS();
  }
});
</script>
</body>
</html>
